function youarehere_locate(){var c=function(d){var e=$("#status");e.html("<li>"+d+"</li>"+e.html())};navigator.geolocation.getCurrentPosition(function(d){d=d.coords;var e=d.latitude,g=d.longitude;c("The sensors have placed you at or around "+e+","+g+".");c("Now to figure out where that is.");setTimeout(function(){location.href=location.href+"?lat="+e+"&lon="+g},2500)},function(){});c("Asking the sky where you are.")};function youarehere_correction_draw_map(c){$.ajax({url:c,success:function(d){youarehere_map_init(d);youarehere_woe_draw_shapes([d.features[0].properties.woe_id])}})};var _map=null,_points=[];function youarehere_map(){if(!_map){$("#".container_id).show();var c=L.map("map",{zoomControl:false,attributionControl:false});L.tileLayer("http://tile.stamen.com/toner-background/{z}/{x}/{y}.jpg",{attribution:"",maxZoom:18,minZoom:1}).addTo(c);_map=c}return _map}function youarehere_map_init(c){youarehere_map();youarehere_map_set_viewport(c);youarehere_map_draw_features(c)}
function youarehere_map_set_viewport(c){var d=youarehere_map();c=c.features[0];var e=c.bbox,g=c.geometry;if(!(c.properties&&c.properties.place_type_id==12))if(g.type=="Point"){c=g.coordinates;d.setView([c[1],c[0]],12)}else if(e){c=[[e[1],e[0]],[e[3],e[2]]];d.getBounds().extend(c)}}
function youarehere_map_draw_features(c){var d=c.features[0];if(!(d.properties&&d.properties.place_type_id==12)){var e=null;d=youarehere_map();var g={color:"#000",weight:2,opacity:1,fillOpacity:0.8,fillColor:"#afceee"},i={color:"red",weight:4,opacity:1,fillOpacity:1,fillColor:"white",radius:8},l=function(b){var a=$("#map-feedback");a.html(b);b?a.show():a.hide()},k=function(b){var a=b.target;b=a.feature;a.setStyle({color:"red",fillColor:"#8ca4be"});if(!L.Browser.ie&&!L.Browser.opera){a.bringToFront();
m()}if(b)if(b.geometry.type=="Point"&&b.properties)$("#iamhere-"+(b.id?b.id:b.properties.id)).attr("class","info");else{if(b.properties){(a=b.properties.label)||(a=b.properties.name);a&&l(a)}if(b.properties)if($("#whereami-places")){(a=b.properties.woe_id)||(a=b.properties.id);a&&$("#woe-"+a).attr("selected","selected")}}},h=function(b){b=b.target;var a=b.feature;e.resetStyle(b);m();l(null);if(a&&a.geometry.type=="Point"&&a.properties)$("#iamhere-"+(a.id?a.id:a.properties.id)).removeAttr("class")},
j=function(b){b=b.target.feature;if(b.properties){b=b.properties;if(b.permalink)location.href=b.permalink}};e=L.geoJson(c,{style:function(b){if(b.geometry.type!="Point")return g},pointToLayer:function(b,a){return L.circleMarker(a,i)},onEachFeature:function(b,a){a.on({click:j,mouseover:k,mouseout:h})}});e.addTo(d);c.features[0].geometry.type=="Point"&&_points.push(e);var m=function(){for(var b=_points.length,a=0;a<b;a++)_points[a].bringToFront()};return e}}
function youarehere_map_latlons_to_geojson(c){for(var d=[],e=c.length,g=0;g<e;g++){var i={type:"Feature",geometry:{type:"Point",coordinates:[c[g][1],c[g][0]]}};if(c[g].length==3)i.properties=c[g][2];d.push(i)}d={type:"FeatureCollection",features:d};if(e>1){c=youarehere_map_coords_to_bbox(c);d.bbox=c}return d}
function youarehere_map_coords_to_bbox(c,d){for(var e=c.length,g=undefined,i=undefined,l=undefined,k=undefined,h=0;h<e;h++){var j=d?c[h][1]:c[h][0],m=d?c[h][0]:c[h][0];g=g==undefined?j:Math.min(g,j);i=i==undefined?m:Math.min(i,m);l=l==undefined?j:Math.max(l,j);k=k==undefined?m:Math.max(k,m)}e=[i,g,k,l];for(h in e)e[h]=e[h].toFixed(3);return e};function youarehere_woe_draw_shapes(c){for(var d=undefined,e=undefined,g=undefined,i=undefined,l=c.length,k=[],h=0;h<l;h++){var j=c[h];j!=-1&&$.inArray(j,k)==-1&&k.push(j)}l=k.length;for(h=0;h<l;h++){j=k[h];c=_cfg.woedb_static_url_template.replace("{W}",j);var m=function(b){var a=undefined;if(b.type=="FeatureCollection"){a=b;b=a.features[0];if(!b.bbox){var f=b.geometry.coordinates;f=f[0][0];f=youarehere_map_coords_to_bbox(f,"lonlat");b.bbox=f;a.features[0]=b}}else{if(!b.bbox){f=b.geometry.coordinates;
f=f[0][0];f=youarehere_map_coords_to_bbox(f,"lonlat");b.bbox=f}a={type:"FeatureCollection",features:[b]}}if(a.features[0].bbox){f=a.features[0].bbox;for(var n in f)f[n]=parseFloat(f[n]);d=d==undefined?f[1]:Math.min(d,f[1]);e=e==undefined?f[0]:Math.min(e,f[0]);g=g==undefined?f[3]:Math.max(g,f[3]);i=i==undefined?f[2]:Math.max(i,f[2])}try{youarehere_map_draw_features(a).bringToBack();youarehere_map_set_viewport(a)}catch(q){}if(a=a.features[0].properties){n=a.woe_id;b=a.label;if(a.id)n=a.id;if(a.name)b=
a.name;$(".woeid-"+n).html(b+" ( "+n+" )")}};j=m;if(h+1==l)j=function(b){m(b);b=[[d,e],[g,i]];youarehere_map().fitBounds(b)};$.ajax({url:c,dataType:"json",success:j,error:function(){}})}};_map=null;_points=[];function youarehere_getlatlon_map(){if(!_map){$("#".container_id).show();var c=L.map("map",{scrollWheelZoom:true,zoomControl:true,attributionControl:false});c.on("move",youarehere_getlatlon_coords);L.tileLayer("http://tile.stamen.com/toner/{z}/{x}/{y}.jpg",{attribution:"",maxZoom:18,minZoom:1}).addTo(c);_map=c}return _map}
function youarehere_getlatlon_set_viewport(c){var d=function(a){var f=undefined,n=undefined,q=undefined,r=undefined;if(a.type=="GeometryCollection")for(var t=a.geometries.length,s=0;s<t;s++){var p=d(a.geometries[s]);f=f==undefined?p[1]:Math.min(f,p[1]);n=n==undefined?p[0]:Math.min(n,p[0]);q=q==undefined?p[3]:Math.max(q,p[3]);r=r==undefined?p[2]:Math.max(r,p[2])}else if(a.type=="Point"){var o=a.coordinates;a=o[1];o=o[0];f=f==undefined?a:Math.min(f,a);n=n==undefined?o:Math.min(n,o);q=q==undefined?a:
Math.max(q,a);r=r==undefined?o:Math.max(r,o)}else if(a.type=="Polygon"){t=a.coordinates;s=t.length;for(p=0;p<s;p++)for(var v=t[p],w=v.length,u=0;u<w;u++){o=v[u];a=o[1];o=o[0];f=f==undefined?a:Math.min(f,a);n=n==undefined?o:Math.min(n,o);q=q==undefined?a:Math.max(q,a);r=r==undefined?o:Math.max(r,o)}}return[f,n,q,r]},e=youarehere_getlatlon_map();c=c.features;for(var g=c.length,i=undefined,l=undefined,k=undefined,h=undefined,j=0;j<g;j++){var m=c[j],b=m.bbox;m=m.geometry;b||(b=d(m));i=i==undefined?b[1]:
Math.min(i,b[1]);l=l==undefined?b[0]:Math.min(l,b[0]);k=k==undefined?b[3]:Math.max(k,b[3]);h=h==undefined?b[2]:Math.max(h,b[2])}i==k&&l==h?e.setView([i,l],12):e.fitBounds([[i,l],[k,h]])}function youarehere_getlatlon_jumpto(c,d,e){var g=youarehere_getlatlon_map();if(e){e=e.split(",");g.fitBounds([[e[1],e[0]],[e[3],e[2]]])}else g.setView([c,d],12)}
function youarehere_getlatlon_draw_features(c){var d=null,e=youarehere_getlatlon_map(),g={color:"#0BBDFF",weight:4,opacity:1,fillOpacity:1,fillColor:"#fff",radius:8},i=function(a){var f=a.target.feature;if(a=f.bbox)a=a.join(",");f=f.geometry.coordinates;youarehere_getlatlon_jumpto(f[1],f[0],a)};d=c.features;for(var l=d.length,k=0;k<l;k++){var h=d[k],j=h.geometry;if(j.type=="GeometryCollection"){j=j.geometries;for(var m=j.length,b=0;b<m;b++)if(j[b].type=="Point"){j=j[b];h.geometry=j;c.features[k]=
h;break}}}d=L.geoJson(c,{pointToLayer:function(a,f){return L.circleMarker(f,g)},onEachFeature:function(a,f){f.on({click:i})}});d.addTo(e)}function youarehere_getlatlon_coords(){var c=youarehere_getlatlon_map(),d=c.getCenter();c=c.getZoom();var e=d.lat;d=d.lng;var g="/maybe?lat="+e+"&lon="+d,i="";i+=e.toFixed(6)+", "+d.toFixed(6);i+=" @ zoom level "+c;i+=' <span class="pointer">\u21e6</span> <a href="'+g+'">I am here</a>';$("#map-coords").html(i)};
