function youarehere_locate(){var b=function(e){var d=$("#status");d.html("<li>"+e+"</li>"+d.html())};navigator.geolocation.getCurrentPosition(function(e){e=e.coords;var d=e.latitude,f=e.longitude;b("The sensors have placed you at or around "+d+","+f+".");b("Now to figure out where that is.");setTimeout(function(){location.href=location.href+"?lat="+d+"&lon="+f},2500)},function(){});b("Asking the sky where you are.")};function youarehere_correction_draw_map(b){$.ajax({url:b,success:function(e){youarehere_map_init(e);youarehere_woe_draw_shapes([e.features[0].properties.woe_id])}})};var _map=null,_points=[];function youarehere_map(){if(!_map){$("#".container_id).show();var b=L.map("map",{zoomControl:false,attributionControl:false});L.tileLayer("http://tile.stamen.com/toner-background/{z}/{x}/{y}.jpg",{attribution:"",maxZoom:18,minZoom:4}).addTo(b);_map=b}return _map}function youarehere_map_init(b){youarehere_map();youarehere_map_set_viewport(b);youarehere_map_draw_features(b)}
function youarehere_map_set_viewport(b){var e=youarehere_map();b=b.features[0];var d=b.bbox,f=b.geometry;if(!(b.properties&&b.properties.place_type_id==12))if(f.type=="Point"){b=f.coordinates;e.setView([b[1],b[0]],12)}else if(d){b=[[d[1],d[0]],[d[3],d[2]]];e.getBounds().extend(b)}}
function youarehere_map_draw_features(b){var e=b.features[0];if(!(e.properties&&e.properties.place_type_id==12)){var d=null;e=youarehere_map();var f={color:"#000",weight:2,opacity:1,fillOpacity:0.8,fillColor:"#afceee"},j={color:"red",weight:4,opacity:1,fillOpacity:1,fillColor:"white",radius:8},k=function(a){var c=$("#map-feedback");c.html(a);a?c.show():c.hide()},l=function(a){var c=a.target;a=c.feature;c.setStyle({color:"red",fillColor:"#8ca4be"});if(!L.Browser.ie&&!L.Browser.opera){c.bringToFront();
m()}if(a)if(a.geometry.type=="Point"&&a.properties)$("#iamhere-"+(a.id?a.id:a.properties.id)).attr("class","info");else{if(a.properties){(c=a.properties.label)||(c=a.properties.name);c&&k(c)}if(a.properties)if($("#whereami-places")){(c=a.properties.woe_id)||(c=a.properties.id);c&&$("#woe-"+c).attr("selected","selected")}}},h=function(a){a=a.target;var c=a.feature;d.resetStyle(a);m();k(null);if(c&&c.geometry.type=="Point")$("#iamhere-"+(c.id?c.id:c.properties.id)).removeAttr("class")},i=function(a){a=
a.target.feature;if(a.properties){a=a.properties;if(a.permalink)location.href=a.permalink}};d=L.geoJson(b,{style:function(a){if(a.geometry.type!="Point")return f},pointToLayer:function(a,c){return L.circleMarker(c,j)},onEachFeature:function(a,c){c.on({click:i,mouseover:l,mouseout:h})}});d.addTo(e);b.features[0].geometry.type=="Point"&&_points.push(d);var m=function(){for(var a=_points.length,c=0;c<a;c++)_points[c].bringToFront()};return d}}
function youarehere_map_latlons_to_geojson(b){for(var e=[],d=b.length,f=0;f<d;f++){var j={type:"Feature",geometry:{type:"Point",coordinates:[b[f][1],b[f][0]]}};if(b[f].length==3)j.properties=b[f][2];e.push(j)}e={type:"FeatureCollection",features:e};if(d>1){b=youarehere_map_coords_to_bbox(b);e.bbox=b}return e}
function youarehere_map_coords_to_bbox(b,e){for(var d=b.length,f=undefined,j=undefined,k=undefined,l=undefined,h=0;h<d;h++){var i=e?b[h][1]:b[h][0],m=e?b[h][0]:b[h][0];f=f==undefined?i:Math.min(f,i);j=j==undefined?m:Math.min(j,m);k=k==undefined?i:Math.max(k,i);l=l==undefined?m:Math.max(l,m)}d=[j,f,l,k];for(h in d)d[h]=d[h].toFixed(3);return d};function youarehere_woe_draw_shapes(b){for(var e=undefined,d=undefined,f=undefined,j=undefined,k=b.length,l=[],h=0;h<k;h++){var i=b[h];i!=-1&&$.inArray(i,l)==-1&&l.push(i)}k=l.length;for(h=0;h<k;h++){i=l[h];b="http://woe.spum.org/id/"+i+"/shape.js";if(i==18807771)b="http://gowanusheights.info/data/gowanus-heights.json";var m=function(a){var c=undefined;if(a.type=="FeatureCollection"){c=a;a=c.features[0];if(!a.bbox){var g=a.geometry.coordinates;g=g[0][0];g=youarehere_map_coords_to_bbox(g,"lonlat");
a.bbox=g;c.features[0]=a}}else{if(!a.bbox){g=a.geometry.coordinates;g=g[0][0];g=youarehere_map_coords_to_bbox(g,"lonlat");a.bbox=g}c={type:"FeatureCollection",features:[a]}}if(c.features[0].bbox){g=c.features[0].bbox;for(var n in g)g[n]=parseFloat(g[n]);e=e==undefined?g[1]:Math.min(e,g[1]);d=d==undefined?g[0]:Math.min(d,g[0]);f=f==undefined?g[3]:Math.max(f,g[3]);j=j==undefined?g[2]:Math.max(j,g[2])}try{youarehere_map_draw_features(c).bringToBack();youarehere_map_set_viewport(c)}catch(o){}if(c=c.features[0].properties){n=
c.woe_id;a=c.label;if(c.id)n=c.id;if(c.name)a=c.name;$(".woeid-"+n).html(a+" ( "+n+" )")}};i=m;if(h+1==k)i=function(a){m(a);a=[[e,d],[f,j]];youarehere_map().fitBounds(a)};$.ajax({url:b,dataType:"json",success:i,error:function(){}})}};
