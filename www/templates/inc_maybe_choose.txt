{if !$rsp.ok}
<p class="error">Well, that's no good. The geo servers appear to be upset and
not willing to play nicely, right now. Let's marvel at the terseness of their
error messages. This is what they are willing to tell us: <q>{$rsp.error|escape}</q></p>

{elseif $rsp.data|@count == 0}
<p>Hrm... we have no idea where you are.</p>
{else}

{* TO DO: add map... *}

{include file="inc_map.txt"}

<div id="correction-select">

<form id="choices" method="POST" action="{$cfg.abs_root_url}maybe/">
{$crumb_key|crumb_input}
<input type="hidden" name="choose" value="1" />
<input type="hidden" name="lat" value="{$latitude|escape}" />
<input type="hidden" name="lon" value="{$longitude|escape}" />
<input type="hidden" name="filter" value="{$filter|escape}" />
	
<span class="correction-select">

<span class="correction-select-text">It appears that you are in</span>

<select name="whereami" id="whereami-places">
<optgroup>
<option selected="selected"/>
</optgroup>
<optgroup>
{foreach from=$rsp.data item="row"}
<option value="{$row.woe_id|escape}" id="woe-{$row.woe_id|escape}" class="location">{if $row.name}{$row.name|escape}{else}{$row.label|escape}{/if}</option>
{/foreach}
</optgroup>
{if $fallback}<optgroup><option value="-2">
None of these are correct but I'd like to see {$fallback|escape}.
</option></optgroup>{/if}
<optgroup><option value="-1">Meh. It's all wrong. I give up.</option></optgroup>
</select>

</span>

<span class="correction-select">
<span class="correction-select-text">and you're saying this as</span>

<select name="perspective" id="whereami-perspective">
<option value="0" />
{foreach from=$perspective_map item="label" key="id"}
<option value="{$id|escape}">{$label|escape}</option>
{/foreach}
</select>

<input type="submit" value="WORD" id="correction-select-submit" class="correction-select" />

</form>

</span>

</div>

<script type="text/javascript">
$(document).ready(function(){literal}{{/literal}
	var latlons = [[{$latitude|escape}, {$longitude|escape}]];
	var geojson = youarehere_map_latlons_to_geojson(latlons);
	youarehere_map_init(geojson);

	var woeids = [{foreach from=$rsp.data item="row" name="woeids"}{$row.woe_id|escape}{if !$smarty.foreach.woeids.last},{/if}{/foreach}];
	youarehere_woe_draw_shapes(woeids);

	{literal}
	$("#whereami-places").change(function(){

		var perspective = $("#whereami-perspective");

		var youarehere = $(this).attr('value');

		if (youarehere == -2){
			perspective.attr("disabled", "disabled");
		}

		else {
			perspective.removeAttr("disabled");
		}
	});
	{/literal}

{literal}}{/literal});
</script>

{/if}
